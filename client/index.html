<html>
	<head>
		<title>Tree Three.js</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<!-- for some reason non-minified three won't work -->
		<script src="//cdn.rawgit.com/mrdoob/three.js/master/build/three.min.js"></script>
		<script src="./js/PLYLoader.js"></script>
		<script src="./js/OrbitControls.js"></script>
	    <script type="x-shader/x-vertex" id="vertexShader">
			varying vec3 vColor;

			uniform float time;
			float fBendScale = 0.0; // bend scale, calculate on CPU
			vec2 vWind = vec2(1.0, 0.5); // wind direction on xz-plane
			varying vec3 vNewPos;

			void main(void) {
				vColor = color;
			    float fLength = length(position.xyz); // pos.xyz, b/c later use!
			    fBendScale = (sin(time)+1.0)*0.05; //todo pick off 0.1 into uniform
			    float fBF = position.x * fBendScale; // fucked up coordinate systems
			    // Smooth bending factor and increase its nearby height limit.
			    //fBF += 1.0;
			    //fBF *= fBF;
			    //fBF = fBF * fBF - fBF;
			    // displace position
			    vNewPos = position;
			    vNewPos.yz += vWind.xy * fBF; // for some reason tree models' supposed xz plane is yz!! (-> x = height)

			    gl_Position = projectionMatrix * modelViewMatrix * vec4( normalize(vNewPos.xyz)* fLength, 1.0 );
			    gl_PointSize = 1.0;
			}
	    </script>

	    <script type="x-shader/x-fragment" id="fragmentShader">
	        varying vec3 vColor;

			void main() {
			    gl_FragColor = vec4(vColor.rgb, 1.0);
			}
	    </script>
		<script>
		
		var TreesDef = {
		    types: [
		        {
		            name: "Test",
		            fileName: "points.ply",
		        },
		                {
		            name: "ThreeTrees",
		            fileName: "3tress_2.ply"
		        },
		         {
		            name: "palm",
		            fileName: "palm.ply"
		        },
		         {
		            name: "single",
		            fileName: "singleTree.ply"
		        },
		            {
		            name: "bush",
		            fileName: "bush.ply"
		        }
		    ],
		    instances: [
		    
		         {
		            type: "ThreeTrees",
		            position: [4,22,14],
		            rotateX: -10,
		            scale: 4.3
		        },
		        //  {
		        //     type: "ThreeTrees",
		        //     position: [4,22,14],
		        //     rotateX: -10,
		        //     scale: 4
		        // },
		        //  {
		        //     type: "ThreeTrees",
		        //     position: [42,24,2],
		        //     rotateX: 0,
		        //     scale: 4.4
		        // }, 
		        {
		            type: "ThreeTrees",
		            position: [43,24,3],
		            rotateX: 0,
		            scale: 4.4
		        },
		        {
		            type: "ThreeTrees",
		            position: [40,24,2],
		            rotateX: 0,
		            scale: 4.4
		        },
		        {
		            type: "ThreeTrees",
		            position: [20,24,-23],
		            rotateX: 80,
		            scale: 4.4
		        },
		      {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 20,
		            scale: 4.4
		        },

		 {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 60,
		            scale: 4.4
		        },

		 {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 60,
		            scale: 4.4
		        },
		    {
		            type: "ThreeTrees",
		            position: [6,23,-10],
		            rotateX: 180,
		            scale: 4.4
		        },
		   
		    {
		            type: "ThreeTrees",
		            position: [-20,26,-20],
		            rotateX: -30,
		            scale: 4
		        },
		   

		    
		    
		        {
		            type: "palm",
		            position: [-18,16,10],
		            rotateX: -100,
		            scale: 3
		        },

		        {
		            type: "palm",
		            position: [8,22,6],
		            rotateX: 60,
		            scale: 3
		        },
		         {
		            type: "palm",
		            position: [-38,20,-32],
		            rotateX: 60,
		            scale: 3.8
		        },
		        // {
		        //     type: "single",
		        //     position: [-52,18,2],
		        //     rotateX: 100,
		        //     scale: 3
		        // },


		        // {
		        //     type: "single",
		        //     position: [20,18,8],
		        //     rotateX: 100,
		        //     scale: 3
		        // }
		   
		    ]
		};
		var uniforms = { time: { type: "f", value: 0 } };

		const TREES_PATH = "./trees";

		class Trees extends THREE.Object3D {
			    constructor() {
			        super();
			    }

			    init(loadingManager) {
			    	console.log("init trees loadingmanager");
			        let treeTypes = {};
			        this.treesLoader = new THREE.PLYLoader(loadingManager);

			        return new Promise((resolve, reject) => {
			            console.log("Loading trees", TreesDef)
			            let typePromises = TreesDef.types.map((type) => {return this.loadType(type, treeTypes)});
			            Promise.all(typePromises)
			            .then((results) => {
			                //let material = new THREE.PointsMaterial( { size: 0.13, vertexColors: true } );
			                material = new THREE.ShaderMaterial( {
			                	uniforms: uniforms,
			                	vertexColors: THREE.VertexColors,
							    vertexShader: document.getElementById( 'vertexShader' ).textContent,
							    fragmentShader: document.getElementById( 'fragmentShader' ).textContent
							} );
						//	material = new THREE.MeshBasicMaterial( { 
						//        color: 0xb7ff00, 
						//        wireframe: true 
						//    } );
			                TreesDef.instances.forEach((instance) => {
			                    let mesh = new THREE.Points( treeTypes[instance.type], material );
			                    mesh.position.fromArray(instance.position);
			                    mesh.scale.set(0.25 * instance.scale, 0.25 * instance.scale, 0.25 * instance.scale);
			                    mesh.rotateZ(90 * Math.PI / 180);
			                    mesh.rotateX(instance.rotateX * Math.PI / 180);
			                    this.add(mesh);
			                    resolve();
			                })
			            });
			        });      
			    }

			    loadType(props,store) {
			        return new Promise((resolve, reject) => {
			            console.log("Loading tree type ", props);
			            this.treesLoader.load(TREES_PATH + "/" + props.fileName ,( geometry ) => {
			                store[props.name] = geometry;
			                resolve();
			            });
			        });
			    }
			}

	        this.loadingManager = new THREE.LoadingManager();

			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 60, window.innerWidth/window.innerHeight, 0.1, 1000 );

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			var geometry = new THREE.BoxGeometry( 1, 1, 1 );
			var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
			var cube = new THREE.Mesh( geometry, material );

			var trees = new Trees();
			trees.init(loadingManager);

			scene.add( trees );

			camera.position.x = 0;
			camera.position.y = 0;
			camera.position.z = 0;
			camera.lookAt( new THREE.Vector3( 10, 15, 10 ) ); //look from straight above
			var clock = new THREE.Clock();
			clock.start();

			var render = function () {
				requestAnimationFrame( render );

				cube.rotation.x += 0.1;
				cube.rotation.y += 0.1;

				renderer.render(scene, camera);
				var delta = clock.getDelta();
				uniforms.time.value += delta;
			};

			render();

			controls = new THREE.OrbitControls( camera, renderer.domElement );
			controls.target.set( 10, 15, 10 );
		</script>
	</body>
</html>