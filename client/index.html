<html>
	<head>
		<title>Tree Shaders</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<!-- for some reason non-minified three won't work on my system -->
		<script src="//cdn.rawgit.com/mrdoob/three.js/master/build/three.min.js"></script>
		<!-- dat.gui for controls -->
		<script src="./js/dat.gui.min.js"></script>
		<!-- copy-pasted for quicker dev -->
		<script src="./js/PLYLoader.js"></script>
		<!-- camera controls for development -->
		<script src="./js/OrbitControls.js"></script>

		<!-- vertex shader -->
	    <script type="x-shader/x-vertex" id="vertexShader">
			varying vec3 vColor;

			uniform float time;
			uniform float bendAmount;
			uniform float speedFactor;
			uniform float heightLimit;
			uniform float pointSize;
			uniform vec2 wind;
			
			void main(void) {
				vColor = color;
			    float fLength = length(position.xyz);
			    float fBend = (sin(time * speedFactor) + 1.0) * bendAmount;
			    float clampedX = max(position.x, heightLimit); // coordinate system is rotated -> x is up
			    float fBF = clampedX * fBend;
			    vec3 vNewPos = position;
			    vNewPos.yz += wind.xy * fBF; // trees' supposed xz plane is yz b/c rotation

			    gl_Position = projectionMatrix * modelViewMatrix * vec4(normalize(vNewPos.xyz) * fLength, 1.0);
			    gl_PointSize = pointSize;
			}
	    </script>

	    <!-- fragment shader -->
	    <script type="x-shader/x-fragment" id="fragmentShader">
	        varying vec3 vColor;

			void main() {
			    gl_FragColor = vec4(vColor.rgb, 1.0);
			}
	    </script>

		<script>
		// sorry for the copy-paste, was the fastest way to get everything up & running		
		var TreesDef = {
		    types: [
		        {
		            name: "Test",
		            fileName: "points.ply",
		        },
		                {
		            name: "ThreeTrees",
		            fileName: "3tress_2.ply"
		        },
		         {
		            name: "palm",
		            fileName: "palm.ply"
		        },
		         {
		            name: "single",
		            fileName: "singleTree.ply"
		        },
		            {
		            name: "bush",
		            fileName: "bush.ply"
		        }
		    ],
		    instances: [
		    
		         {
		            type: "ThreeTrees",
		            position: [4,22,14],
		            rotateX: -10,
		            scale: 4.3
		        },
		        //  {
		        //     type: "ThreeTrees",
		        //     position: [4,22,14],
		        //     rotateX: -10,
		        //     scale: 4
		        // },
		        //  {
		        //     type: "ThreeTrees",
		        //     position: [42,24,2],
		        //     rotateX: 0,
		        //     scale: 4.4
		        // }, 
		        {
		            type: "ThreeTrees",
		            position: [43,24,3],
		            rotateX: 0,
		            scale: 4.4
		        },
		        {
		            type: "ThreeTrees",
		            position: [40,24,2],
		            rotateX: 0,
		            scale: 4.4
		        },
		        {
		            type: "ThreeTrees",
		            position: [20,24,-23],
		            rotateX: 80,
		            scale: 4.4
		        },
		      {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 20,
		            scale: 4.4
		        },

		 {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 60,
		            scale: 4.4
		        },

		 {
		            type: "ThreeTrees",
		            position: [30,24,-20],
		            rotateX: 60,
		            scale: 4.4
		        },
		    {
		            type: "ThreeTrees",
		            position: [6,23,-10],
		            rotateX: 180,
		            scale: 4.4
		        },
		   
		    {
		            type: "ThreeTrees",
		            position: [-20,26,-20],
		            rotateX: -30,
		            scale: 4
		        },
		   

		    
		    
		        {
		            type: "palm",
		            position: [-18,16,10],
		            rotateX: -100,
		            scale: 3
		        },

		        {
		            type: "palm",
		            position: [8,22,6],
		            rotateX: 60,
		            scale: 3
		        },
		         {
		            type: "palm",
		            position: [-38,20,-32],
		            rotateX: 60,
		            scale: 3.8
		        },
		        // {
		        //     type: "single",
		        //     position: [-52,18,2],
		        //     rotateX: 100,
		        //     scale: 3
		        // },


		        // {
		        //     type: "single",
		        //     position: [20,18,8],
		        //     rotateX: 100,
		        //     scale: 3
		        // }
		   
		    ]
		};

		// here's the uniforms we'll need for the ShaderMaterial
		var uniforms = { 
			time: { type: "f", value: 0 },
			bendAmount: { type: "f", value: 0.05 },
			speedFactor: { type: "f", value: 1.0 },
            wind: { type: "v2", value: new THREE.Vector2 ( 1.0, 0.5 ) },
            heightLimit: { type: "f", value: 0.0 },
            pointSize: { type: "f", value: 2.0 }
        };

        // again a bit dirty
		const TREES_PATH = "./trees";

		class Trees extends THREE.Object3D {
			    constructor() {
			        super();
			    }

			    init(loadingManager) {
			    	console.log("init trees loadingmanager");
			        let treeTypes = {};
			        this.treesLoader = new THREE.PLYLoader(loadingManager);

			        return new Promise((resolve, reject) => {
			            console.log("Loading trees", TreesDef)
			            let typePromises = TreesDef.types.map((type) => {return this.loadType(type, treeTypes)});
			            Promise.all(typePromises)
			            .then((results) => {
			                // this is the ShaderMaterial we need to use for the trees 
			                var material = new THREE.ShaderMaterial( {
			                	uniforms: uniforms,
			                	vertexColors: THREE.VertexColors,
							    vertexShader: document.getElementById( 'vertexShader' ).textContent,
							    fragmentShader: document.getElementById( 'fragmentShader' ).textContent
							} );
							// end of interesting stuff
			                TreesDef.instances.forEach((instance) => {
			                    let mesh = new THREE.Points( treeTypes[instance.type], material );
			                    mesh.position.fromArray(instance.position);
			                    mesh.scale.set(0.25 * instance.scale, 0.25 * instance.scale, 0.25 * instance.scale);
			                    mesh.rotateZ(90 * Math.PI / 180);
			                    mesh.rotateX(instance.rotateX * Math.PI / 180);
			                    this.add(mesh);
			                    resolve();
			                })
			            });
			        });      
			    }

			    loadType(props,store) {
			        return new Promise((resolve, reject) => {
			            console.log("Loading tree type ", props);
			            this.treesLoader.load(TREES_PATH + "/" + props.fileName ,( geometry ) => {
			                store[props.name] = geometry;
			                resolve();
			            });
			        });
			    }
			}

	        this.loadingManager = new THREE.LoadingManager();

	        // set up the scene & camera
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 60, window.innerWidth/window.innerHeight, 0.1, 1000 );
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
			camera.position.x = 0;
			camera.position.y = 0;
			camera.position.z = 0;
			camera.lookAt( new THREE.Vector3( 10, 15, 10 ) );
			controls = new THREE.OrbitControls( camera, renderer.domElement );
			controls.target.set( 10, 15, 10 );

			// load & add the trees
			var trees = new Trees();
			trees.init(loadingManager);
			scene.add( trees );

			// dat.gui
			window.onload = function() {
				var gui = new dat.GUI();
				var f1 = gui.addFolder('bendAmount');
				f1.add(uniforms.bendAmount, 'value', -0.5, 0.5);
				var f2 = gui.addFolder('speedFactor');
				f2.add(uniforms.speedFactor, 'value', -5, 5);
				var f3 = gui.addFolder('wind');
				//wind: { type: "v2", value: new THREE.Vector2 ( 1.0, 0.5 ) },
				var f4 = gui.addFolder('heightLimit');
				f4.add(uniforms.heightLimit, 'value', -10, 10);
				var f5 = gui.addFolder('pointSize');
				f5.add(uniforms.pointSize, 'value', 0, 5);
			};



			// we need to pass delta time to the shader so we need a clock
			var clock = new THREE.Clock();
			clock.start();

			var render = function () {
				requestAnimationFrame( render );
				renderer.render(scene, camera);

				// update time
				var delta = clock.getDelta();
				uniforms.time.value += delta;
			};

			render();

		</script>
	</body>
</html>